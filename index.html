<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monarkky Finance - Dark Edition</title>
    <style>
        :root {
            --primary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --dark-bg: #121212;
            --card-bg: rgba(30, 30, 30, 0.8);
            --text-light: #e0e0e0;
            --border: rgba(255, 255, 255, 0.1);
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            margin: 0; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh;
            color: var(--text-light);
        }

        /* --- AUTH BOX --- */
        #authOverlay {
            background: var(--card-bg);
            backdrop-filter: blur(15px);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            text-align: center;
            width: 380px;
            border: 1px solid var(--border);
        }

        h2 { margin-top: 0; color: #fff; letter-spacing: 1px; }

        input, select {
            width: 100%;
            padding: 14px;
            margin-bottom: 15px;
            border-radius: 10px;
            border: 1px solid var(--border);
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            outline: none;
            transition: 0.3s;
        }

        select option { color: #000 !important; background: #fff !important; }
        input:focus, select:focus { border-color: var(--primary); background: rgba(255, 255, 255, 0.1); }

        button {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
        }

        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        .btn-alt { background: transparent; border: 1px solid var(--border); margin-top: 10px; }

        /* --- DASHBOARD STYLING --- */
        #mainContent { 
            display: none; 
            width: 95%; 
            max-width: 1150px; 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 24px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
            margin: 20px auto;
            border: 1px solid var(--border);
        }

        .header-dash { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; flex-wrap: wrap; gap: 15px;}
        .form-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        
        .save-wrapper { display: flex; justify-content: center; width: 100%; margin-bottom: 30px; }
        .btn-save { background-color: var(--success); width: 100%; max-width: 400px; }

        /* --- CATEGORY TABS --- */
        .category-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        .btn-category {
            background: rgba(255, 255, 255, 0.1);
            width: auto;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85em;
            border: 1px solid transparent;
        }
        .btn-category.active {
            background: var(--primary);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.4);
        }
        
        /* New Category Input */
        .new-cat-group { display: flex; gap: 5px; min-width: 200px; }
        .new-cat-group input { margin-bottom: 0; padding: 10px; }
        .new-cat-group button { width: auto; padding: 10px 15px; background: var(--success); }

        .filter-section { 
            background: rgba(255, 255, 255, 0.03); 
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 20px; 
            display: flex; 
            flex-wrap: wrap; 
            gap: 15px; 
            align-items: flex-end; 
            border: 1px solid var(--border);
        }

        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; background: transparent; }
        th { background: rgba(52, 152, 219, 0.2); color: var(--primary); font-weight: 600; text-transform: uppercase; font-size: 0.85em; }
        th, td { padding: 16px; text-align: left; border-bottom: 1px solid var(--border); }
        tr:hover { background: rgba(255, 255, 255, 0.02); }
        
        .nominal-plus { color: #2ecc71; font-weight: bold; }
        .nominal-minus { color: #ff4757; font-weight: bold; }
        
        .btn-del { 
            background-color: var(--danger); 
            padding: 8px 12px; 
            font-size: 0.9em; 
            width: auto; 
            border-radius: 8px;
        }

        #labelTotalPerBank { width: 100%; font-weight: bold; color: var(--primary); font-size: 1.1em; text-align: right; margin-top: 10px;}
        .logout-btn { background: var(--danger); width: auto; padding: 8px 18px; font-size: 0.8em; }
        ::placeholder { color: rgba(255,255,255,0.4); }
    </style>
</head>
<body>

    <div id="authOverlay">
        <div id="loginBox">
            <h2>üîê Login System</h2>
            <p style="font-size: 0.9em; opacity: 0.6; margin-bottom: 25px;">Masukkan kredensial Cloud</p>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button id="btnLogin" onclick="checkLogin()">Masuk Sekarang</button>
            <button class="btn-alt" onclick="showRegister()">Daftar Akun Baru</button>
            <p id="errMsg" style="color: var(--danger); font-size: 0.85em; margin-top: 15px; display: none;">Username atau Password salah!</p>
        </div>

        <div id="registerBox" style="display: none;">
            <h2>üìù Registrasi</h2>
            <input type="text" id="regUser" placeholder="Buat Username">
            <input type="password" id="regPass" placeholder="Buat Password">
            <input type="text" id="regOtp" placeholder="OTP Admin (Rahasia)" style="border: 1px solid var(--warning);">
            <button id="btnProsesDaftar" onclick="prosesDaftar()" style="background: var(--success);">Konfirmasi Daftar</button>
            <button class="btn-alt" onclick="hideRegister()">Batal</button>
        </div>
    </div>

    <div id="mainContent">
        <div class="header-dash">
            <h2 id="welcomeText" style="margin:0;">Monarkky Finance üí∞ | <span id="userNameSpan" style="font-weight: 200; opacity: 0.7;">Hi! User</span></h2>
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
        </div>
        
        <div class="category-tabs" id="kategoriContainer">
            </div>

        <div class="form-group">
            <input type="date" id="tanggal">
            <input type="text" id="nama" placeholder="Nama Transaksi" autocomplete="off">
            <input type="text" id="keterangan" placeholder="Keterangan" autocomplete="off">
            <select id="bank">
                <option value="">-- Pilih Bank --</option>
                <option value="BCA">BCA</option>
                <option value="Mandiri">Mandiri</option>
                <option value="BRI">BRI</option>
                <option value="BNI">BNI</option>
                <option value="Cash">Cash / Tunai</option>
            </select>
            <input type="number" id="nominal" placeholder="Nominal (- jika keluar)" autocomplete="off">
        </div>

        <div class="save-wrapper">
            <button id="btnSimpan" class="btn-save" onclick="tambahData()">SIMPAN KE KATEGORI: <span id="labelBtnSimpan">UMUM</span></button>
        </div>

        <div class="filter-section">
            <div style="flex:1; min-width: 200px;">
                <label style="font-size: 0.75em; opacity: 0.6; font-weight: bold; margin-bottom: 5px; display: block;">FILTER BANK</label>
                <select id="filterBank" onchange="tampilkanData()">
                    <option value="SEMUA">Semua Bank</option>
                    <option value="BCA">BCA</option>
                    <option value="Mandiri">Mandiri</option>
                    <option value="BRI">BRI</option>
                    <option value="BNI">BNI</option>
                    <option value="Cash">Cash</option>
                </select>
            </div>
            <div style="flex:1; min-width: 200px;">
                <label style="font-size: 0.75em; opacity: 0.6; font-weight: bold; margin-bottom: 5px; display: block;">FILTER TANGGAL</label>
                <input type="date" id="filterTanggal" onchange="tampilkanData()">
            </div>
            <button onclick="resetFilter()" style="width: auto; background:#555; height: 45px; margin-bottom: 15px;">RESET</button>
            <div id="labelTotalPerBank"></div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Nama</th>
                        <th>Keterangan</th>
                        <th>Bank</th>
                        <th>Nominal</th>
                        <th>Saldo Akhir</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="isiTabel">
                    <tr><td colspan="7" style="text-align:center; padding: 50px; opacity: 0.5;">Memuat data dari Cloud...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

<script>
    // --- GANTI DENGAN URL DEPLOY BARU ANDA JIKA BERUBAH ---
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyUXDyVzwZHcdP5EzkNbCeYfpeYGPoyF2muxQRcDsGlFWQuZA59_8ZYWFHpB8kmNczkfw/exec";
    
    let timeout;
    const waktuTunggu = 30 * 60 * 1000; 
    
    // Default kategori
    let activeKategori = "UMUM";
    let listKategori = ["UMUM", "TABUNGAN", "BISNIS"]; // List bawaan

    window.onload = function() {
        if (sessionStorage.getItem("isLoggedIn") === "true") {
            // Load custom kategori dari localstorage jika ada
            const savedCats = localStorage.getItem("monarkky_cats");
            if(savedCats) listKategori = JSON.parse(savedCats);
            
            showDashboard();
            mulaiTimer();
        }
    };

    function mulaiTimer() {
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            alert("Sesi berakhir karena tidak ada aktivitas.");
            logout();
        }, waktuTunggu);
    }
    document.onmousemove = mulaiTimer;
    document.onkeypress = mulaiTimer;

    async function checkLogin() {
        const uInput = document.getElementById('user').value;
        const pInput = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        
        if(!uInput || !pInput) return;
        btn.innerText = "Checking...";
        btn.disabled = true;

        try {
            const res = await fetch(SCRIPT_URL);
            const db = await res.json();
            const userFound = db.users.find(row => row[0].toString().toLowerCase() === uInput.toLowerCase() && row[1].toString() === pInput);

            if (userFound) {
                sessionStorage.setItem("isLoggedIn", "true");
                sessionStorage.setItem("activeUser", userFound[0]); 
                showDashboard();
            } else {
                document.getElementById('errMsg').style.display = 'block';
                btn.innerText = "Masuk Sekarang";
                btn.disabled = false;
            }
        } catch (e) { alert("Gagal koneksi!"); btn.disabled = false; }
    }

    async function prosesDaftar() {
        const u = document.getElementById('regUser').value;
        const p = document.getElementById('regPass').value;
        const o = document.getElementById('regOtp').value;
        const btn = document.getElementById('btnProsesDaftar');

        if(!u || !p || !o) { alert("Lengkapi semua kolom!"); return; }
        btn.innerText = "Mendaftarkan...";
        btn.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify({ action: "register", username: u, password: p, otp: o })
            });
            const result = await response.text();
            if (result.includes("Success")) {
                alert("Pendaftaran Berhasil! Silakan Login.");
                hideRegister();
            } else {
                alert(result);
            }
        } catch (e) { alert("Gagal koneksi server."); } 
        finally { btn.innerText = "Konfirmasi Daftar"; btn.disabled = false; }
    }

    function showDashboard() {
        const activeName = sessionStorage.getItem("activeUser") || "User";
        document.getElementById('userNameSpan').innerText = `Hi! ${activeName}`;
        document.getElementById('authOverlay').style.display = "none";
        document.getElementById('mainContent').style.display = "block";
        
        document.getElementById('tanggal').value = new Date().toLocaleDateString('en-CA');
        document.getElementById('nama').focus(); 
        
        renderKategoriTabs();
        tampilkanData();
    }

    function logout() { 
        sessionStorage.clear(); 
        location.reload(); 
    }

    function showRegister() { document.getElementById('loginBox').style.display = 'none'; document.getElementById('registerBox').style.display = 'block'; }
    function hideRegister() { document.getElementById('loginBox').style.display = 'block'; document.getElementById('registerBox').style.display = 'none'; }

    // --- LOGIKA MULTI-KATEGORI ---
    function renderKategoriTabs() {
        const container = document.getElementById('kategoriContainer');
        container.innerHTML = "";
        
        listKategori.forEach(kat => {
            const btn = document.createElement('button');
            btn.className = `btn-category ${kat === activeKategori ? 'active' : ''}`;
            btn.innerText = kat;
            btn.onclick = () => switchKategori(kat);
            container.appendChild(btn);
        });

        // Input tambah kategori baru
        const divBaru = document.createElement('div');
        divBaru.className = "new-cat-group";
        divBaru.innerHTML = `
            <input type="text" id="inputNewCat" placeholder="+ Kat Baru" style="width:120px; font-size:0.8em;">
            <button onclick="tambahKategoriBaru()">ADD</button>
        `;
        container.appendChild(divBaru);

        document.getElementById('labelBtnSimpan').innerText = activeKategori;
    }

    function switchKategori(kat) {
        activeKategori = kat;
        renderKategoriTabs();
        tampilkanData(); // Refresh data sesuai tab yg diklik
    }

    function tambahKategoriBaru() {
        const inputVal = document.getElementById('inputNewCat').value.trim().toUpperCase();
        if (!inputVal) return;
        if (listKategori.includes(inputVal)) {
            alert("Kategori sudah ada!");
            return;
        }
        // Tambah ke array dan simpan ke localstorage agar tidak hilang saat direfresh
        listKategori.push(inputVal);
        localStorage.setItem("monarkky_cats", JSON.stringify(listKategori));
        switchKategori(inputVal);
    }

    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });

    async function tambahData() {
        const btn = document.getElementById('btnSimpan');
        const elNama = document.getElementById('nama');
        const elKet = document.getElementById('keterangan');
        const elNom = document.getElementById('nominal');
        const elBank = document.getElementById('bank');
        const elTgl = document.getElementById('tanggal');

        const payload = {
            kategori: activeKategori, // Kirim nama kategori ke server
            tanggal: elTgl.value,
            nama: elNama.value,
            keterangan: elKet.value,
            bank: elBank.value,
            nominal: parseFloat(elNom.value)
        };
        
        if (!payload.nama || isNaN(payload.nominal) || !payload.bank || !payload.tanggal) { 
            alert("Harap isi semua kolom dengan benar!"); 
            return; 
        }
        
        btn.disabled = true; 
        btn.innerText = "Menyimpan...";
        
        try {
            const response = await fetch(SCRIPT_URL, { 
                method: "POST", 
                body: JSON.stringify(payload) 
            });
            const result = await response.text();

            if (result.includes("Success")) {
                alert(`‚úÖ Data Berhasil Disimpan ke Kategori: ${activeKategori}`);
                
                elNama.value = ""; 
                elKet.value = ""; 
                elNom.value = "";
                elTgl.value = new Date().toLocaleDateString('en-CA');
                elNama.focus();

                btn.disabled = false;
                btn.innerHTML = `SIMPAN KE KATEGORI: <span id="labelBtnSimpan">${activeKategori}</span>`;
                tampilkanData(); 
            } else {
                alert("Gagal: " + result);
                btn.disabled = false;
                btn.innerHTML = `SIMPAN KE KATEGORI: <span id="labelBtnSimpan">${activeKategori}</span>`;
            }
        } catch (e) { 
            alert("Terjadi kesalahan koneksi!"); 
            btn.disabled = false; 
            btn.innerHTML = `SIMPAN KE KATEGORI: <span id="labelBtnSimpan">${activeKategori}</span>`;
        } 
    }

    async function hapusData(idx) {
        if (!confirm("Apakah Anda yakin ingin menghapus data ini?")) return;

        const btn = event.target;
        btn.innerText = "‚åõ";
        btn.disabled = true;

        try {
            const response = await fetch(SCRIPT_URL, {
                method: "POST",
                // Kirim juga parameter kategori agar script tahu di sheet mana data harus dihapus
                body: JSON.stringify({ action: "delete", rowIndex: idx, kategori: activeKategori })
            });
            const result = await response.text();

            if (result.includes("Success")) {
                tampilkanData(); 
            } else {
                alert("Gagal menghapus: " + result);
                tampilkanData();
            }
        } catch (e) {
            alert("Kesalahan koneksi.");
            tampilkanData();
        }
    }

    async function tampilkanData() {
        const tbody = document.getElementById('isiTabel');
        const fBank = document.getElementById('filterBank').value;
        const fTgl = document.getElementById('filterTanggal').value;
        
        tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; padding: 20px; opacity: 0.5;'>Memuat data...</td></tr>";

        try {
            // Ambil data spesifik berdasarkan kategori yg aktif
            const targetUrl = `${SCRIPT_URL}?kategori=${encodeURIComponent(activeKategori)}`;
            const response = await fetch(targetUrl);
            const db = await response.json();
            
            tbody.innerHTML = "";
            let totalFiltered = 0;
            const historyData = db.transaksi;

            if (!historyData || historyData.length === 0) {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; opacity:0.5;'>Tidak ada data pada kategori ini.</td></tr>";
                document.getElementById('labelTotalPerBank').innerText = "";
                return;
            }

            historyData.slice().reverse().forEach((row, revIdx) => {
                const originalIndex = (historyData.length - 1) - revIdx;
                
                const dateObj = new Date(row[0]);
                const rowDate = dateObj.toLocaleDateString('en-CA');
                
                if ((fBank === "SEMUA" || row[3] === fBank) && (!fTgl || rowDate === fTgl)) {
                    const nom = parseFloat(row[4]);
                    totalFiltered += nom;
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${dateObj.toLocaleDateString('id-ID')}</td>
                        <td>${row[1]}</td>
                        <td>${row[2]}</td>
                        <td>${row[3]}</td>
                        <td class="${nom >= 0 ? 'nominal-plus' : 'nominal-minus'}">${formatter.format(nom)}</td>
                        <td style="font-weight:bold; color: #fff;">${formatter.format(row[5])}</td>
                        <td><button class="btn-del" onclick="hapusData(${originalIndex})">üóëÔ∏è</button></td>
                    `;
                    tbody.appendChild(tr);
                }
            });
            
            document.getElementById('labelTotalPerBank').innerText = (fBank !== "SEMUA" || fTgl) ? `Ringkasan: ${formatter.format(totalFiltered)}` : "";
            
            if (tbody.innerHTML === "") {
                tbody.innerHTML = "<tr><td colspan='7' style='text-align:center; opacity:0.5;'>Tidak ada data yang sesuai filter.</td></tr>";
            }
        } catch (e) { 
            tbody.innerHTML = "<tr><td colspan='7' style='text-align:center;'>Gagal memuat data. Periksa URL SCRIPT_URL Anda.</td></tr>"; 
        }
    }

    function resetFilter() { 
        document.getElementById('filterBank').value = "SEMUA"; 
        document.getElementById('filterTanggal').value = ""; 
        tampilkanData(); 
    }
</script>
</body>
</html>
