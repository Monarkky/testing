<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monarkky Finance - Hybrid Dark Edition</title>
    <style>
        :root {
            --primary: #3498db; --success: #2ecc71; --danger: #e74c3c; --warning: #f1c40f;
            --dark-bg: #0f2027; --card-bg: rgba(25, 25, 25, 0.9);
            --text-light: #e0e0e0; --border: rgba(255, 255, 255, 0.1);
        }
        body { 
            font-family: 'Segoe UI', sans-serif; margin: 0; min-height: 100vh;
            background: linear-gradient(135deg, #0f2027 0%, #203a43 50%, #2c5364 100%);
            color: var(--text-light); display: flex; flex-direction: column; align-items: center; padding: 20px;
        }
        .glass { background: var(--card-bg); backdrop-filter: blur(15px); border-radius: 20px; border: 1px solid var(--border); box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        
        /* --- AUTH BOX --- */
        #authOverlay { width: 380px; padding: 40px; text-align: center; margin-top: 10vh; box-sizing: border-box; }
        input, select { width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255, 255, 255, 0.05); color: #fff; outline: none; transition: 0.3s; box-sizing: border-box;}
        select option { color: #000; }
        input:focus { border-color: var(--primary); background: rgba(255, 255, 255, 0.1); }
        button { width: 100%; padding: 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; text-transform: uppercase; }
        .btn-alt { background: transparent; border: 1px solid var(--border); color: #fff; margin-top: 10px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }

        /* --- CATEGORY SECTION (New Feature) --- */
        #categorySection { display: none; width: 100%; max-width: 900px; text-align: center; }
        .cat-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .cat-card { padding: 40px 20px; cursor: pointer; position: relative; transition: 0.3s; }
        .cat-card:hover { transform: translateY(-5px); background: rgba(52, 152, 219, 0.2); }
        .delete-cat-btn { position: absolute; top: 10px; right: 10px; background: none; color: var(--danger); font-size: 18px; width: auto; padding: 5px; opacity: 0.5; transition: 0.3s;}
        .delete-cat-btn:hover { opacity: 1; transform: scale(1.2); }

        /* --- MAIN DASHBOARD --- */
        #mainContent { display: none; width: 100%; max-width: 1150px; }
        .cat-title-display { text-align: center; font-size: 2.2em; font-weight: 800; margin: 10px 0; color: #fff; text-transform: uppercase; letter-spacing: 3px; }
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px; padding: 20px; }
        .table-container { overflow-x: auto; padding: 0 20px 20px 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid var(--primary); color: var(--primary); font-size: 0.8em; }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 0.9em; }
        .nominal-plus { color: #2ecc71; font-weight: bold; }
        .nominal-minus { color: #e74c3c; font-weight: bold; }
        
        .btn-del { background: var(--danger); padding: 5px 10px; width: auto; font-size: 12px; }
        .filter-box { display: flex; gap: 15px; padding: 15px 20px; align-items: center; flex-wrap: wrap; }
    </style>
</head>
<body>

    <div id="authOverlay" class="glass">
        <div id="loginBox">
            <h2>üîê Login System</h2>
            <p style="font-size: 0.9em; opacity: 0.6; margin-bottom: 25px;">Kredensial Cloud Terenkripsi</p>
            <input type="text" id="user" placeholder="Username">
            <input type="password" id="pass" placeholder="Password">
            <button class="btn-primary" id="btnLogin" onclick="checkLogin()">Masuk Sekarang</button>
            <button class="btn-alt" onclick="showRegister()">Daftar Akun Baru</button>
            <p id="errMsg" style="color: var(--danger); font-size: 0.85em; margin-top: 15px; display: none;">Kredensial tidak valid!</p>
        </div>

        <div id="registerBox" style="display: none;">
            <h2>üìù Registrasi</h2>
            <input type="text" id="regUser" placeholder="Buat Username">
            <input type="password" id="regPass" placeholder="Buat Password">
            <input type="text" id="regOtp" placeholder="OTP Admin (Rahasia)" style="border: 1px solid var(--warning);">
            <button id="btnProsesDaftar" class="btn-success" onclick="prosesDaftar()">Konfirmasi Daftar</button>
            <button class="btn-alt" onclick="hideRegister()">Batal</button>
        </div>
    </div>

    <div id="categorySection">
        <div style="display:flex; justify-content: space-between; align-items:center;">
            <h2 id="welcomeText">Hi! Pilih Kategori</h2>
            <button onclick="logout()" style="width:auto; padding: 8px 15px; background:var(--danger); color:#fff; font-size: 11px; border-radius: 8px;">LOGOUT</button>
        </div>
        <div class="cat-grid" id="categoryGrid"></div>
        <div class="glass" style="padding:25px; max-width: 400px; margin: 0 auto;">
            <h4 style="margin-top:0">+ Kategori Baru</h4>
            <input type="text" id="newCatName" placeholder="Contoh: Bisnis, Pribadi">
            <button class="btn-success" id="btnTambahCat" onclick="addNewCategory()">BUAT KATEGORI</button>
        </div>
    </div>

    <div id="mainContent">
        <button onclick="backToCategories()" style="width:auto; margin-bottom:10px; background:#555; color:#fff; padding: 8px 15px; border-radius: 8px; font-size: 12px;">‚¨Ö Kembali ke Menu</button>
        <div class="cat-title-display" id="activeCategoryName">DASHBOARD</div>
        
        <div class="glass">
            <div class="form-row">
                <input type="date" id="tanggal">
                <input type="text" id="nama" placeholder="Nama Transaksi">
                <input type="text" id="keterangan" placeholder="Keterangan">
                <select id="bank">
                    <option value="Cash">Cash / Tunai</option>
                    <option value="BCA">BCA</option>
                    <option value="Mandiri">Mandiri</option>
                    <option value="BRI">BRI</option>
                    <option value="BNI">BNI</option>
                </select>
                <input type="number" id="nominal" placeholder="Nominal (- keluar)">
                <button class="btn-success" id="btnSimpan" onclick="simpanData()">SIMPAN</button>
            </div>

            <hr style="border: 0; border-top: 1px solid var(--border); margin: 0;">

            <div class="filter-box">
                <div style="flex:1;">
                    <select id="filterBank" onchange="refreshTable()">
                        <option value="SEMUA">Semua Bank</option>
                        <option value="BCA">BCA</option>
                        <option value="Mandiri">Mandiri</option>
                        <option value="BRI">BRI</option>
                        <option value="BNI">BNI</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <input type="date" id="filterTanggal" onchange="refreshTable()">
                </div>
                <div id="labelTotalPerBank" style="font-weight:bold; color:var(--primary);"></div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>TANGGAL</th><th>NAMA</th><th>KET</th><th>BANK</th><th>NOMINAL</th><th>SALDO</th><th>AKSI</th>
                        </tr>
                    </thead>
                    <tbody id="isiTabel"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // MASUKKAN URL DEPLOYMENT ANDA DI SINI
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxv9Xydu53NNdjxeMMXRiemw-RPH7CcfcuE8r74YxheYj0rdL_0ZbLNpUGW0xN423H1/exec";
    
    let activeCategory = "";
    const formatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });

    // ANTI-LOGOUT: Cek sesi saat refresh
    window.onload = function() {
        if (sessionStorage.getItem("isLoggedIn") === "true") {
            silentRefreshMenu();
        }
    };

    function showRegister() { document.getElementById('loginBox').style.display='none'; document.getElementById('registerBox').style.display='block'; }
    function hideRegister() { document.getElementById('loginBox').style.display='block'; document.getElementById('registerBox').style.display='none'; }

    async function checkLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const btn = document.getElementById('btnLogin');
        if(!u || !p) return;
        btn.innerText = "Checking...";
        try {
            const res = await fetch(SCRIPT_URL);
            const db = await res.json();
            const userFound = db.users.find(row => row[0].toString() === u && row[1].toString() === p);
            if (userFound) {
                sessionStorage.setItem("isLoggedIn", "true");
                sessionStorage.setItem("activeUser", userFound[0]);
                showCategories(db.categories);
            } else {
                document.getElementById('errMsg').style.display = 'block';
                btn.innerText = "Masuk Sekarang";
            }
        } catch (e) { alert("Koneksi Gagal"); btn.innerText = "Masuk Sekarang"; }
    }

    async function prosesDaftar() {
        const u = document.getElementById('regUser').value;
        const p = document.getElementById('regPass').value;
        const o = document.getElementById('regOtp').value;
        const btn = document.getElementById('btnProsesDaftar');
        if(!u || !p || !o) return;
        btn.innerText = "Processing...";
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'register', username: u, password: p, otp: o }) });
            const result = await res.text();
            if(result.includes("Success")) { alert("Berhasil! Silakan Login."); hideRegister(); } else { alert(result); }
        } catch (e) { alert("Error Server"); } finally { btn.innerText = "Konfirmasi Daftar"; }
    }

    async function silentRefreshMenu() {
        try {
            const res = await fetch(SCRIPT_URL);
            const db = await res.json();
            showCategories(db.categories);
        } catch(e) { console.log("Refresh Error"); }
    }

    function showCategories(categories) {
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('categorySection').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        const grid = document.getElementById('categoryGrid');
        grid.innerHTML = "";
        categories.forEach(cat => {
            const card = document.createElement('div');
            card.className = "glass cat-card";
            card.innerHTML = `<button class="delete-cat-btn" onclick="deleteCategory(event, '${cat}')">üóëÔ∏è</button>
                              <div onclick="openCategory('${cat}')"><h3 style="margin:0">${cat}</h3></div>`;
            grid.appendChild(card);
        });
    }

    async function addNewCategory() {
        const name = document.getElementById('newCatName').value.trim();
        if (!name) return;
        const btn = document.getElementById('btnTambahCat');
        btn.disabled = true; btn.innerText = "Menciptakan...";
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'addCategory', categoryName: name }) });
            document.getElementById('newCatName').value = "";
            await silentRefreshMenu();
        } catch (e) { alert("Gagal"); } finally { btn.disabled = false; btn.innerText = "BUAT KATEGORI"; }
    }

    async function deleteCategory(e, name) {
        e.stopPropagation();
        if (!confirm(`Hapus seluruh kategori ${name}?`)) return;
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteCategory', categoryName: name }) });
            silentRefreshMenu();
        } catch (e) { alert("Gagal"); }
    }

    async function openCategory(name) {
        activeCategory = name;
        document.getElementById('categorySection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('activeCategoryName').innerText = name;
        document.getElementById('tanggal').value = new Date().toLocaleDateString('en-CA', {timeZone: 'Asia/Jakarta'});
        refreshTable();
    }

    async function refreshTable() {
        const tbody = document.getElementById('isiTabel');
        const fBank = document.getElementById('filterBank').value;
        const fTgl = document.getElementById('filterTanggal').value;
        
        tbody.innerHTML = "<tr><td colspan='7' style='text-align:center'>Memuat Sinkronisasi...</td></tr>";
        
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'loadData', categoryName: activeCategory }) });
        const data = await res.json();
        
        tbody.innerHTML = "";
        let totalFiltered = 0;

        data.slice().reverse().forEach((row, revIdx) => {
            const originalIndex = (data.length - 1) - revIdx;
            const dateObj = new Date(row[0]);
            const rowDate = dateObj.toLocaleDateString('en-CA');
            
            // Logika Filter (Dipertahankan dari versi Anda)
            if ((fBank === "SEMUA" || row[3] === fBank) && (!fTgl || rowDate === fTgl)) {
                const nom = parseFloat(row[4]);
                totalFiltered += nom;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${dateObj.toLocaleDateString('id-ID')}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td class="${nom >= 0 ? 'nominal-plus' : 'nominal-minus'}">${formatter.format(nom)}</td>
                    <td style="font-weight:bold">${formatter.format(row[5])}</td>
                    <td><button class="btn-del" onclick="hapusRow(${originalIndex})">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(tr);
            }
        });
        document.getElementById('labelTotalPerBank').innerText = `Ringkasan: ${formatter.format(totalFiltered)}`;
    }

    async function simpanData() {
        const btn = document.getElementById('btnSimpan');
        const payload = {
            action: 'saveTransaction', categoryName: activeCategory,
            tanggal: document.getElementById('tanggal').value,
            nama: document.getElementById('nama').value,
            keterangan: document.getElementById('keterangan').value,
            bank: document.getElementById('bank').value,
            nominal: parseFloat(document.getElementById('nominal').value)
        };
        if(!payload.nama || !payload.nominal) return alert("Lengkapi data!");
        
        btn.disabled = true; btn.innerText = "...";
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            // AUTO CLEAR INPUT (New Upgrade)
            document.getElementById('nama').value = "";
            document.getElementById('keterangan').value = "";
            document.getElementById('nominal').value = "";
            refreshTable();
        } catch(e) { alert("Gagal"); } finally { btn.disabled = false; btn.innerText = "SIMPAN"; }
    }

    async function hapusRow(idx) {
        if(!confirm("Hapus transaksi ini?")) return;
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', categoryName: activeCategory, rowIndex: idx }) });
        refreshTable();
    }

    function backToCategories() {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('categorySection').style.display = 'block';
        silentRefreshMenu();
    }

    function logout() { sessionStorage.clear(); location.reload(); }
</script>
</body>
</html>
